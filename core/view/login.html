<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="data:;base64,=">  <!-- 禁止加载facon.ico -->
    <title>User Login</title>

    <!-- 软件包导入(jquery放在anguarjs前， bootstrap放在jquery-ui前) -->
    <script src="/node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script> 
    <script src="/node_modules/angular/angular.min.js" type="text/javascript"></script>
    <!-- bootstrap -->   
    <script src="/node_modules/popper.js/dist/umd/popper.min.js" type="text/javascript"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <link  href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- toastr(notify) -->
    <script src="/node_modules/toastr/build/toastr.min.js" type="text/javascript"></script>
    <link  href="/node_modules/toastr/build/toastr.min.css" rel="stylesheet" /> 
    <!-- font-awesome -->
    <link  href="/node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
</head>
<body ng-app="loginApp" ng-controller="loginCtrl">

    <div class="jumbotron jumbotron-fluid px-3" style="margin-top: 100px;"> 
        <h1 class="display-5">用户登录</h1>
        <p class="lead font-italic">该系统需要登录才能访问！</p>
        <hr class="my-4">
        <form class="container">
            <div class="form-group row">
                <div class="col-lg">
                    <input type="text" class="form-control form-control-lg" id="username" ng-model="username"  placeholder="账户" />
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg">
                <input type="password" class="form-control form-control-lg" id="password" ng-model="password" ng-keydown="$event.keyCode == 13 && login();" placeholder="密码">
                </div>
            </div>
            <div class="row">
                <div class="col-md text-center">
                    <button type="button" class="btn btn-lg btn-outline-success btn-block" ng-click="login();">登录</button>
                </div>
            </div>
        </form>
    </div>

</body>
</html>
<script>
angular
.module('loginApp', [])
.controller('loginCtrl', ($scope, $http, $window)=>
{
    toastr.options = { closeButton: false, debug: false, progressBar: true, positionClass: "toast-bottom-right",  
        onclick: null, showDuration: "300", hideDuration: "1000", timeOut: "2000", extendedTimeOut: "1000",  
        showEasing: "swing", hideEasing: "linear", showMethod: "fadeIn", hideMethod: "fadeOut"  
    };

    $scope.username  = '';
    $scope.password  = '';
    
    $scope.login = ()=>{
        var username = $scope.username;
        var password = $scope.password;
        if (!password || !username) { return toastr.info("请输入有效的账户及密码!", '', {"positionClass": "toast-bottom-right"}); }

        $http
        .post('/user/login', {'username':username, 'password': password})
        .then((res)=>{
            if (res.errorCode) { return toastr.info(res.message, '', {"positionClass": "toast-bottom-right"}); }

            if (res.data.errorCode) {
                toastr.info(res.data.message, '', {"positionClass": "toast-bottom-right"});
            } else {
                var obj = res.data.message;
               
                // 将登录用户注册到localStorage中
                $window.localStorage['/user']=JSON.stringify(obj);
                $window.localStorage['/lastuser']=obj.username;
                window.location.href = '/';
            }            
        });
    }
});  
</script> 
